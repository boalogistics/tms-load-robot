import os, time
import pandas as pd
import tms_login as tms
from datetime import date

# set to Chrome default download folder
DOWNLOAD_FOLDER = "C:\\Users\\daigo\\Downloads"

# list of files before downloading
before = os.listdir(DOWNLOAD_FOLDER)

url = 'https://boa.3plsystemscloud.com/'
browser = tms.login(url, False)

# loop over Accessorial reports 1-8
reports = {
    'A1': '38738038E4E4',
    'A2': '38738039C4E4',
    'A3': '3873803A34E4',
    'A4': '3873803AA4E4',
    'A5': '3873803B14E4',
    'A6': '3873873724E4',
    'A7': '3873873794E4',
    'A8': '3873873804E4'
}

# List of load numbers to get accessorials for
load_nos = ['155622', '155623', '155624', '155625', '155626', '155627', '155672', '155673', '155674', '155675', '155676', '155677', '155662', '155663', '155664', '155665', '155666', '155667', '155652', '155653', '155654', '155655', '155656', '155657', '155642', '155643', '155644', '155645', '155646', '155647', '155632', '155633', '155634', '155635', '155636', '155637', '148367', '150183', '150776', '150872', '157897', '161434', '162343', '162288', '163033', '165270', '174125', '155740', '155903', '164155', '165277', '146342', '146345', '147534', '158999', '164160', '144201', '144202', '144204', '163421', '170847', '170857', '171507', '172498', '173330', '173933', '150248', '151296', '152858', '143686', '143918', '145119', '145120', '175202', '173353', '173927', '173930', '173944', '174579', '175195', '172310', '172592', '172610', '173335', '173336', '173337', '170848', '170948', '171506', '171739', '172036', '169140', '169460', '170239', '170240', '170361', '170845', '167955', '167988', '167999', '168458', '168464', '166611', '166714', '167197', '167222', '167227', '164707', '164710', '165275', '165276', '165283', '165458', '162919', '164037', '164148', '164150', '164154', '164163', '161779', '161842', '162308', '162912', '162913', '160604', '160615', '161236', '161237', '161244', '159414', '159465', '160128', '160252', '160253', '160600', '158995', '158997', '159003', '159410', '159411', '159412', '154588', '156089', '156091', '156150', '156605', '158937', '149439', '149641', '150258', '150432', '150817', '152354', '148427', '148428', '148429', '148430', '149123', '149124', '147688', '147689', '147694', '147696', '148326', '145121', '145175', '145780', '147303', '146181', '172048', '170850', '171518', '161255', '174906', '164165', '143678', '145258', '146977', '147741', '149108', '150296', '143826', '172596', '156090', '159429', '160617', '161254', '170250', '171510', '172052', '173352', '159004', '152359', '167987', '147697', '168474', '169134', '169459', '171512', '172604', '166598', '166612', '167224', '167238', '168000', '168456', '161253', '161837', '161845', '162916', '163420', '164708', '154586', '154587', '156541', '160616', '161248', '160610', '155148', '156543', '161834', '162279', '162910', '170364', '169146', '171527', '148503', '144805', '146110', '146664', '147166', '147630', '148365', '172000', '172584', '173905', '174512', '161264', '161738', '161751', '162905', '163384', '170797', '157913', '157914', '159408', '159936', '160564', '149051', '149779', '150292', '150868', '157870', '144038', '144419', '145029', '145253', '145319', '145539', '148366', '149531', '150748', '145926', '146458', '146573', '147153', '147809', '147810', '145445', '165268', '171517', '172600', '173938', '169137', '168463', '168471', '144188', '145335', '145881', '145891', '145892', '146809', '174602', '174957', '173341', '173342', '173343', '173943', '174593', '174600', '171474', '171511', '172042', '172044', '172045', '172601', '169789', '169790', '169795', '170242', '170851', '170853', '167994', '167998', '168472', '168473', '169142', '169143', '165282', '165288', '166603', '167228', '167230', '167993', '163418', '164151', '164161', '164713', '164716', '165281', '162314', '162915', '162917', '162920', '162924', '162925', '160608', '161252', '161843', '162093', '162094', '162234', '159007', '159417', '159418', '159420', '160254', '160260', '147144', '147701', '149126', '149652', '155151', '159000', '169794', '159018', '169104', '166923', '145584', '144206', '144286', '144634', '146485', '147273', '149114', '173350', '173932', '174585', '174591', '175552', '168139', '169461', '169468', '169786', '172591', '173334', '165312', '165460', '166597', '167225', '167850', '167953', '160562', '160603', '161749', '162918', '163415', '165278', '155149', '155684', '156613', '158916', '158994', '159409', '149128', '150053', '151449', '152360', '154811', '155146', '167991', '172609', '144189', '164717', '170365', '149637', '161118', '163416', '165280', '168460', '173347', '144113', '144203', '144628', '144629', '144630', '171539', '171540', '171499', '171500', '171501', '171502', '171504', '170942', '170943', '170944', '171497', '171498', '169138', '169148', '169381', '169788', '169796', '170241', '165290', '167226', '167400', '167989', '168457', '161830', '161832', '161836', '162309', '161239', '161240', '161241', '161242', '158996', '160601', '160893', '160943', '161238', '151295', '151299', '152355', '152356', '158993', '150816', '150818', '150819', '150823', '150824', '149639', '149647', '150251', '150253', '148431', '148434', '149115', '149116', '149120', '147304', '147683', '147685', '147686', '147690', '147693', '146480', '146483', '146484', '147299', '147301', '144640', '144641', '145123', '145781', '145785', '164152', '164162', '167995', '166331', '168475', '169465', '170253', '172611', '173351', '173945', '174604', '171526', '154974', '143516', '143518', '143841', '144069', '144071', '144638', '174596', '174599', '174601', '173345', '173346', '173934', '173935', '173936', '173941', '172597', '172598', '172599', '172605', '172606', '173339', '171519', '171525', '171843', '171939', '172041', '172043', '170246', '170248', '170251', '170856', '171513', '171516', '169144', '169147', '169463', '169791', '169792', '169969', '168461', '168465', '168466', '168468', '168470', '168591', '165289', '166608', '166610', '167233', '167234', '167235', '164157', '164159', '164213', '164645', '164714', '164715', '162929', '162930', '162932', '163417', '163425', '164156', '161247', '161251', '161835', '162313', '162315', '162923', '159428', '160255', '160264', '160265', '160605', '160606', '155919', '156092', '156093', '156274', '156608', '159419', '150833', '151297', '151298', '154813', '154959', '155150', '150262', '150821', '150822', '150829', '150830', '150831', '148449', '148684', '149118', '149122', '149129', '150252', '146812', '146897', '147302', '147691', '147699', '148070', '144835', '145127', '145786', '146350', '146351', '146489', '145788', '144383', '175220', '175460', '172331', '173071', '173285', '174610', '170964', '169133', '162397', '162906', '161736', '161737', '159935', '151399', '151217', '149774', '150534', '148368', '147170', '146335', '161840', '161841', '169077', '170236', '170259', '174595', '150170', '144647', '147695', '150644', '150820', '154826', '159006', '171505', '172034', '172590', '173333', '174578', '175197', '164712', '166596', '167980', '168497', '169466', '170360', '143520', '144636', '144637', '146810', '147664', '148432', '159416', '160261', '161250', '150264', '150825', '150826', '155918', '156097', '156272', '148433', '149125', '149640', '150254', '150255', '150260', '143517', '143519', '144187', '171523', '167229', '166652', '161245', '160609', '147692', '145730', '147308', '146491', '147306', '149127', '149649', '150261', '155153', '156094', '156611', '159415', '160256', '161833', '164720', '154825', '170245', '144208', '145129', '167990', '170247', '170249', '144276', '144893', '149311', '166651', '170243', '144072', '144110', '144112', '144116', '144624', '144632', '174589', '174590', '174603', '174724', '145732', '171509', '172037', '172038', '172593', '172594', '173953', '168307', '168311', '168454', '168459', '170301', '171508', '167236', '167237', '167290', '167849', '167985', '167986', '164659', '164718', '165285', '166594', '166595', '166602', '163422', '163423', '163997', '164164', '164166', '164167', '162311', '162312', '162415', '162616', '162926', '162927', '161246', '161249', '161257', '161838', '161839', '161847', '160250', '160251', '160259', '160513', '160611', '160612', '159413', '159424', '159426', '159626', '160248', '160249', '150835', '154815', '156095', '156612', '157587', '158998', '149636', '149638', '149650', '150249', '150250', '150642', '146487', '146490', '147305', '147687', '147698', '148856', '145783', '145787', '145789', '146479', '146482', '146486', '144633', '145124', '145125', '145516', '145745', '145782', '145582', '146895', '148136', '167769', '155998', '152358', '155147', '158870', '160010', '161846', '162914', '167220', '160614', '163100', '163424', '162310', '163354', '168103', '170233', '164589', '150834', '165286', '165287', '166605', '166606', '167232', '167996', '168469', '169145', '172046', '145100', '146488', '149121', '149507', '152357', '172639', '154812', '148435', '169141', '144865', '145122', '145778', '145779', '145829', '149346', '151293', '175531', '174587', '174588', '174710', '174840', '175196', '175199', '174580', '174581', '174582', '174583', '174584', '174586', '172588', '172675', '173331', '173332', '173928', '173954', '171038', '171496', '171503', '172032', '172033', '172587', '169139', '169149', '169469', '169787', '170252', '170793', '167223', '167564', '168452', '168453', '169135', '169136', '163699', '164185', '164706', '164711', '166600', '167192', '151395', '160191', '160737', '160945', '161243', '162922', '146896', '147307', '156067', '163385', '164141', '164690', '165279', '166599', '173929', '174517', '167930', '168455', '169458', '169467', '170362', '172583', '144186', '144639', '145126', '145128', '145784', '146811', '174597', '172608', '173340', '173344', '173940', '173942', '174379', '170854', '170855', '171321', '171514', '171515', '172047', '170244', '170254', '170363', '170366', '170660', '170846', '167997', '168462', '168467', '169462', '169464', '169793', '165129', '166604', '166607', '166609', '167098', '167231', '161256', '162152', '162931', '163419', '164158', '164719', '159427', '159615', '160257', '160602', '160607', '160613', '156607', '156609', '156610', '159001', '159002', '159421', '150559', '151609', '154912', '156096', '156273', '156606', '149648', '149651', '149653', '150205', '150259', '150263', '147300', '147309', '147700', '148071', '148436', '149451', '170852', '143823', '168944', '174001', '173302', '173937', '173939', '172040', '172595', '172049', '172050', '173348', '173349', '173931', '174058', '174592', '173338', '173869', '174594', '172602', '172603', '171524', '143281', '143282', '144022', '144070', '144170', '144171', '155670', '155671', '155678', '155679', '155680', '155681', '155658', '155659', '155660', '155661', '155668', '155669', '155640', '155641', '155648', '155649', '155650', '155651', '155628', '155629', '155630', '155631', '155638', '155639', '173623', '175625', '150002', '150209', '171521', '171522', '172589', '173221', '166836', '167719', '167992', '170849', '171044', '171520', '165790', '165822', '165826', '165828', '166601', '166825', '165611', '165625', '165642', '165692', '165708', '165763', '164149', '164153', '164709', '165284', '165583', '165600', '160263', '160599', '161831', '162921', '163021', '163414', '159422', '159423', '159425', '160247', '160258', '160262', '155917', '157798', '157800', '158992', '159005', '159204', '151294', '154814', '154816', '155152', '155185', '155621', '150257', '150803', '150827', '150828', '150832', '151166', '148006', '148912', '148913', '149117', '149119', '149148', '147999', '148000', '148001', '148002', '148004', '148005', '147993', '147994', '147995', '147996', '147997', '147998', '147976', '147985', '147987', '147988', '147991', '147992', '147967', '147968', '147969', '147971', '147974', '147975', '147960', '147962', '147963', '147964', '147965', '147966', '147954', '147955', '147956', '147957', '147958', '147959', '147948', '147949', '147950', '147951', '147952', '147953', '147942', '147943', '147944', '147945', '147946', '147947', '147849', '147850', '147852', '147938', '147939', '147940', '147757', '147758', '147833', '147836', '147843', '147847', '147495', '147496', '147497', '147498', '147501', '147684', '147489', '147490', '147491', '147492', '147493', '147494', '147057', '147058', '147484', '147486', '147487', '147488', '147050', '147051', '147053', '147054', '147055', '147056', '147043', '147044', '147045', '147047', '147048', '147049', '146970', '146971', '146972', '146973', '146974', '146975', '146964', '146965', '146966', '146967', '146968', '146969', '146856', '146857', '146858', '146859', '146962', '146963', '146846', '146851', '146852', '146853', '146854', '146855', '146840', '146841', '146842', '146843', '146844', '146845', '146834', '146835', '146836', '146837', '146838', '146839', '146824', '146825', '146827', '146828', '146832', '146833', '144635', '145729', '145777', '146180', '146481', '146822', '144546', '144547', '144625', '144626', '144627', '144631', '144205', '144207', '144542', '144543', '144544', '144545']
output = "'" + "', '".join(load_nos) + "'"

for key in reports:
    # list of files before downloading
    before = os.listdir(DOWNLOAD_FOLDER)
    
    report_code = reports[key]
    report_url = 'https://boa.3plsystemscloud.com/App_BW/staff/Reports/ReportViewer.aspx?code=' + report_code
    browser.get(report_url)

    browser.execute_script("document.getElementById('table-wherevalue').firstElementChild.firstElementChild.value =`" + output + "`;")

    # load_no_box = browser.find_element_by_xpath("//td[1]/input[@class='filter']")
    # load_no_box.clear()
    # load_no_box.send_keys(output)
    

    # save & view report, then download
    save_button = browser.find_element_by_id('ctl00_ContentBody_butSaveView')
    save_button.click()
    browser.implicitly_wait(30)
    download = browser.find_element_by_id('ctl00_ContentBody_butExportToExcel')
    download.click()
    time.sleep(3)

    #compares list of files in Downloads folder after downloading file to extract filename
    after = os.listdir(DOWNLOAD_FOLDER)
    change = set(after) - set(before)

    if len(change) == 1:
        file_name = change.pop()
        print(file_name + ' downloaded.')
    elif len(change) == 0:
        print('No file downloaded.')
    else:
        print ('More than one file downloaded.')
        
    # sets filepath to downloaded file and create DataFrame from file 
    # output file extension is .xls but is actually.html format

    filepath = DOWNLOAD_FOLDER + "\\" + file_name
    data = pd.read_html(filepath)
    df = data[0]
    df.drop(len(df.index) - 1, inplace=True)
    load_range = f'{load_nos[0]}_{load_nos[-1]}' 

    filesave = DOWNLOAD_FOLDER + "\\access\\" + key + "_" + load_range + ".csv"

    df.to_csv(filesave, index = False)
    print("Saved file " + filesave + "!")
    
    new_source = DOWNLOAD_FOLDER + "\\access\\" + key + "-" + load_range + ".html"
    os.rename(filepath, new_source)
    print("Renamed " + filepath + " to " + new_source + "!")

browser.close()